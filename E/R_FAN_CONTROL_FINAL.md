# E/R 팬 대수 제어 로직 (최종 확정)

## 📋 실제 운전 기준

### **대수 제어 원칙**

```
1. 주파수 60Hz (최대) & 10초 지속
   → 더 이상 주파수를 올릴 수 없음
   → 대수 증가 (3대 → 4대)
   → 주파수를 52Hz로 감소 (전체 풍량 유지)

2. 주파수 40Hz (최소) & 10초 지속
   → 더 이상 주파수를 내릴 수 없음
   → 대수 감소 (4대 → 3대, 최소 2대)
   → 주파수를 48Hz로 증가 (전체 풍량 유지)

3. 40-60Hz 중간 대역
   → 현재 대수 유지
   → 주파수로 제어
```

### **T6 온도 제어 (최소 주파수만 보장)**

```
T6 > 44°C: 최소 52Hz (PID가 60Hz까지 올릴 수 있음)
T6 > 42°C: 최소 48Hz (정상 범위)
T6 40-42°C: PID 출력 - 2Hz (최소 40Hz)
T6 < 40°C: PID 출력 - 4Hz (최소 40Hz)
```

**중요**: T6 온도 제어는 **최소값만 보장**하고, **최대값(60Hz)을 제한하지 않습니다!**

---

## 🔧 수정 내역

### **문제 1: 58Hz에서 대수 증가**
- **원인**: T6 > 45°C일 때 `max(decision.er_fan_freq, 58.0)`로 58Hz 제한
- **결과**: PID가 60Hz를 출력해도 58Hz로 제한되어 대수 증가 조건 미충족
- **해결**: T6 > 44°C일 때 최소 52Hz만 보장, 60Hz 출력 허용

### **문제 2: 매번 다른 결과**
- **원인**: Python 바이트코드 캐시 (`__pycache__`)
- **결과**: 코드 수정 후에도 이전 버전 실행
- **해결**: 
  - `__pycache__` 삭제
  - `dashboard.py`의 `controller_version` 증가 (2 → 3)

### **문제 3: 대수 증가 조건 오류**
- **원인**: 52Hz에서 대수 증가 조건 설정
- **결과**: 60Hz까지 올릴 수 있는데 너무 이른 시점에 대수 증가
- **해결**: 60Hz에서 대수 증가 조건으로 변경

---

## ✅ 예상 시나리오 흐름

### **E/R 환기 불량 시나리오**

```
Phase 1-2 (0-3분): T6 상승 (42→48°C)
  → PID 출력 증가 (48→60Hz)
  → T6 > 44°C이므로 최소 52Hz 보장
  → PID가 60Hz 출력 가능

Phase 3 (3-4분): 60Hz 도달 & 10초 지속
  → 대수 증가 (3대 → 4대) ✅
  → 주파수 52Hz로 감소

Phase 4-5 (4-8분): T6 하강 (48→41°C)
  → 주파수 감소 (52→40Hz)

Phase 6-7 (8-12분): T6 안정 (38~39°C)
  → 주파수 40Hz & 10초 지속
  → 대수 감소 (4대 → 3대) ✅
  → 주파수 48Hz로 증가
```

---

## 🚀 테스트 방법

1. **캐시 삭제 확인**
   ```powershell
   Get-ChildItem -Path . -Include __pycache__ -Recurse -Force | Remove-Item -Recurse -Force
   ```

2. **브라우저 새로고침 (F5)**

3. **시나리오 테스트**
   - "E/R 환기 불량" 선택
   - 진행률 관찰:
     - 3-4분: 60Hz → 4대 증가
     - 8-12분: 40Hz → 3대 감소

---

## 📝 핵심 원칙

1. **주파수 최대/최소 도달 → 대수 변경**
2. **T6 온도 제어는 최소값만 보장, 최대값 제한 없음**
3. **대수 변경 시 주파수 조정으로 풍량 급변 방지**
4. **최소 2대 운전 유지 (기본 규칙)**

---

생성일: 2025-10-15
버전: 3.0 (최종 확정)




