# PID 게인(상수) 결정 방법

> **⚠️ 중요:** 이 문서에서 제시하는 **큰 값(예: Kp=5.0)은 가능한 최대 범위**를 보여주는 것이지, 실제 사용 권장값이 아닙니다!  
> **실제 시스템에서는 Kp=1.5~2.0, Ki=0.3~0.4, Kd=0.5~0.6 정도의 값**을 사용합니다.

## 📋 목차
1. [PID 게인이란?](#pid-게인이란)
2. [기본 게인 설정](#기본-게인-설정)
3. [게인 결정 방법](#게인-결정-방법)
4. [적응형 게인 스케줄링](#적응형-게인-스케줄링)
5. [실제 튜닝 과정](#실제-튜닝-과정)
6. [튜닝 예시](#튜닝-예시)

---

## 🎯 PID 게인이란?

### 3가지 게인 상수

```python
Kp (비례 게인): 현재 오차에 대한 반응 강도
Ki (적분 게인): 누적 오차에 대한 반응 강도
Kd (미분 게인): 오차 변화율에 대한 반응 강도
```

### 각 게인의 역할

| 게인 | 역할 | 증가 시 효과 | 부작용 |
|------|------|-------------|--------|
| **Kp** | 즉각 반응 | 빠른 응답 | 오버슈트, 진동 |
| **Ki** | 정상 상태 오차 제거 | 오차 완전 제거 | 느린 응답, 불안정 |
| **Kd** | 변화 억제 | 오버슈트 감소 | 노이즈 증폭 |

---

## ⚙️ 기본 게인 설정

### 현재 시스템 설정

```python
# T5 제어 (FW Outlet, 목표: 35°C)
T5_BASE_GAINS = {
    'Kp': 1.5,   # 비례 게인
    'Ki': 0.3,   # 적분 게인
    'Kd': 0.5    # 미분 게인
}

# T6 제어 (E/R Temperature, 목표: 43°C)
T6_BASE_GAINS = {
    'Kp': 2.0,   # 비례 게인
    'Ki': 0.4,   # 적분 게인
    'Kd': 0.6    # 미분 게인
}
```

### 왜 T6가 더 큰 게인을 사용하나?

**T5 (FW Outlet):**
- 변화가 느림 (열교환기 통과)
- 안정성 중요
- 작은 게인으로 충분

**T6 (E/R Temperature):**
- 변화가 빠름 (공기 온도)
- 빠른 응답 필요
- 큰 게인 필요

---

## 🔬 게인 결정 방법

### 방법 1: Ziegler-Nichols 방법 (실험적)

#### 단계 1: 임계 게인 찾기
```
1. Ki = 0, Kd = 0으로 설정
2. Kp를 0부터 서서히 증가
3. 시스템이 지속적으로 진동할 때의 Kp = Ku (임계 게인)
4. 진동 주기 측정 = Tu
```

#### 단계 2: 게인 계산
```python
# Classic PID
Kp = 0.6 × Ku
Ki = 2 × Kp / Tu
Kd = Kp × Tu / 8

# 예시: Ku = 4.0, Tu = 10초
Kp = 0.6 × 4.0 = 2.4
Ki = 2 × 2.4 / 10 = 0.48
Kd = 2.4 × 10 / 8 = 3.0
```

### 방법 2: Cohen-Coon 방법 (모델 기반)

#### 단계 1: 시스템 응답 측정
```
1. 계단 입력 인가 (예: 주파수 40Hz → 50Hz)
2. 온도 응답 곡선 측정
3. 파라미터 추출:
   - K (정상 상태 게인)
   - τ (시간 상수)
   - L (지연 시간)
```

#### 단계 2: 게인 계산
```python
R = L / τ  # 지연비

Kp = (1/K) × (1.35/R + 0.27)
Ki = Kp × (τ/(L × (1.2 + 2R)))
Kd = Kp × (L × (0.37 - 0.37R))
```

### 방법 3: 수동 튜닝 (Manual Tuning)

#### 단계별 접근

**1단계: Kp 조정 (Ki=0, Kd=0)**
```
시작: Kp = 0
증가: Kp를 서서히 증가
목표: 빠른 응답, 약간의 오버슈트 허용
정지: 진동이 시작되기 직전

예시:
  Kp = 1.0: 너무 느림
  Kp = 2.0: 적당함 (약간 오버슈트)
  Kp = 3.0: 진동 발생
  → 선택: Kp = 2.0
```

**2단계: Ki 조정 (Kd=0)**
```
시작: Ki = 0
증가: Ki를 서서히 증가
목표: 정상 상태 오차 제거
정지: 진동이나 불안정 발생 전

예시:
  Ki = 0.0: 오차 남음
  Ki = 0.4: 오차 제거, 안정
  Ki = 0.8: 진동 발생
  → 선택: Ki = 0.4
```

**3단계: Kd 조정**
```
시작: Kd = 0
증가: Kd를 서서히 증가
목표: 오버슈트 감소
정지: 노이즈 증폭 전

예시:
  Kd = 0.0: 오버슈트 큼
  Kd = 0.6: 오버슈트 감소
  Kd = 1.2: 노이즈 증폭
  → 선택: Kd = 0.6
```

---

## 📊 적응형 게인 스케줄링

### 개념

**기본 게인 × 스케일 팩터 = 실제 게인**

```python
actual_gains = base_gains × load_scale × temp_correction
```

### 엔진 부하별 조정

```python
LOAD_SCALE_FACTORS = {
    "low":    0.8,   # 0-30% (안정성 우선)
    "medium": 1.0,   # 30-70% (표준)
    "high":   1.2    # 70-100% (응답성 우선)
}
```

**이유:**
- **저부하**: 시스템이 안정적, 느린 응답 허용
- **중부하**: 표준 운전 조건
- **고부하**: 빠른 응답 필요, 온도 변화 빠름

**예시:**
```python
# 기본 게인
base_Kp = 2.0

# 저부하 (20%)
actual_Kp = 2.0 × 0.8 = 1.6

# 중부하 (50%)
actual_Kp = 2.0 × 1.0 = 2.0

# 고부하 (80%)
actual_Kp = 2.0 × 1.2 = 2.4
```

### 해수 온도별 보정

```python
SEAWATER_TEMP_CORRECTIONS = {
    "tropical":   1.2,   # > 28°C (적극적 냉각)
    "temperate":  1.0,   # 15-28°C (표준)
    "polar":      0.8    # < 15°C (과냉각 방지)
}
```

**이유:**
- **열대**: 냉각 효율 낮음, 적극적 제어 필요
- **온대**: 표준 조건
- **극지**: 냉각 효율 높음, 과냉각 방지

**예시:**
```python
# 기본 게인
base_Kp = 2.0

# 열대 (30°C)
actual_Kp = 2.0 × 1.2 = 2.4

# 온대 (20°C)
actual_Kp = 2.0 × 1.0 = 2.0

# 극지 (10°C)
actual_Kp = 2.0 × 0.8 = 1.6
```

### 통합 계산

```python
def calculate_adaptive_gains(
    base_gains: PIDGains,
    engine_load: float,
    seawater_temp: float
) -> PIDGains:
    # 부하 구간 판단
    if engine_load < 30:
        load_scale = 0.8
    elif engine_load < 70:
        load_scale = 1.0
    else:
        load_scale = 1.2
    
    # 온도 구간 판단
    if seawater_temp > 28:
        temp_correction = 1.2
    elif seawater_temp < 15:
        temp_correction = 0.8
    else:
        temp_correction = 1.0
    
    # 최종 스케일
    total_scale = load_scale × temp_correction
    
    # 게인 조정
    return PIDGains(
        Kp = base_gains.Kp × total_scale,
        Ki = base_gains.Ki × total_scale,
        Kd = base_gains.Kd × total_scale
    )
```

**실제 예시:**
```python
# 조건
base_Kp = 2.0
engine_load = 80%  # 고부하
seawater_temp = 30°C  # 열대

# 계산
load_scale = 1.2
temp_correction = 1.2
total_scale = 1.2 × 1.2 = 1.44

# 최종 게인
actual_Kp = 2.0 × 1.44 = 2.88
```

---

## 🔧 실제 튜닝 과정

### Step 1: 초기 게인 설정

```python
# 보수적인 시작값
Kp = 1.0
Ki = 0.1
Kd = 0.0
```

### Step 2: 응답 관찰

```
테스트 시나리오:
1. 목표 온도 변경 (43°C → 45°C)
2. 응답 곡선 관찰
3. 성능 지표 측정:
   - 상승 시간 (Rise Time)
   - 오버슈트 (Overshoot)
   - 정착 시간 (Settling Time)
   - 정상 상태 오차 (Steady-State Error)
```

### Step 3: Kp 조정

```
목표: 빠른 응답

Kp = 1.0:
  상승 시간: 300초 (너무 느림)
  오버슈트: 0%
  → Kp 증가

Kp = 2.0:
  상승 시간: 150초 (적당)
  오버슈트: 5%
  → 적당함

Kp = 3.0:
  상승 시간: 100초 (빠름)
  오버슈트: 15% (너무 큼)
  진동 발생
  → Kp 감소

선택: Kp = 2.0
```

### Step 4: Ki 조정

```
목표: 정상 상태 오차 제거

Ki = 0.0:
  정상 상태 오차: 0.5°C (있음)
  → Ki 증가

Ki = 0.2:
  정상 상태 오차: 0.1°C (작음)
  → Ki 증가

Ki = 0.4:
  정상 상태 오차: 0.0°C (없음)
  안정성: 좋음
  → 적당함

Ki = 0.6:
  정상 상태 오차: 0.0°C
  안정성: 진동 발생
  → Ki 감소

선택: Ki = 0.4
```

### Step 5: Kd 조정

```
목표: 오버슈트 감소

Kd = 0.0:
  오버슈트: 5%
  → Kd 증가

Kd = 0.3:
  오버슈트: 3%
  → Kd 증가

Kd = 0.6:
  오버슈트: 1%
  노이즈: 없음
  → 적당함

Kd = 1.0:
  오버슈트: 0.5%
  노이즈: 증폭됨
  → Kd 감소

선택: Kd = 0.6
```

### Step 6: 최종 검증

```python
# 최종 게인
Kp = 2.0
Ki = 0.4
Kd = 0.6

# 성능 지표
상승 시간: 150초 ✓
오버슈트: 1% ✓
정착 시간: 200초 ✓
정상 상태 오차: 0.0°C ✓
```

---

## 📈 튜닝 예시

### 예시 1: T6 제어 (E/R 온도)

#### 시스템 특성
```
목표 온도: 43°C
현재 온도: 40°C
제어 대상: E/R 팬 주파수 (40-60Hz)
```

#### 초기 테스트 (Kp=1.0, Ki=0, Kd=0)

```
시간 0초: T6 = 40°C, 주파수 = 40Hz
시간 60초: T6 = 41°C (너무 느림!)
시간 120초: T6 = 42°C
시간 180초: T6 = 42.5°C
시간 300초: T6 = 42.8°C (정상 상태 오차 0.2°C)

문제점:
- 상승 시간 너무 김 (300초)
- 정상 상태 오차 있음
```

#### Kp 증가 (Kp=2.0, Ki=0, Kd=0)

```
시간 0초: T6 = 40°C, 주파수 = 40Hz
시간 30초: T6 = 41°C (빠름!)
시간 60초: T6 = 42°C
시간 90초: T6 = 43.5°C (오버슈트 0.5°C)
시간 120초: T6 = 43.0°C
시간 150초: T6 = 42.8°C (정상 상태 오차 0.2°C)

개선:
- 상승 시간 단축 (150초)
- 약간의 오버슈트 발생

문제:
- 정상 상태 오차 여전히 있음
```

#### Ki 추가 (Kp=2.0, Ki=0.4, Kd=0)

```
시간 0초: T6 = 40°C, 주파수 = 40Hz
시간 30초: T6 = 41°C
시간 60초: T6 = 42°C
시간 90초: T6 = 43.5°C (오버슈트 0.5°C)
시간 120초: T6 = 43.2°C
시간 150초: T6 = 43.0°C
시간 180초: T6 = 43.0°C (정상 상태 오차 0.0°C)

개선:
- 정상 상태 오차 제거!

문제:
- 오버슈트 여전히 있음
```

#### Kd 추가 (Kp=2.0, Ki=0.4, Kd=0.6)

```
시간 0초: T6 = 40°C, 주파수 = 40Hz
시간 30초: T6 = 41°C
시간 60초: T6 = 42°C
시간 90초: T6 = 43.2°C (오버슈트 0.2°C)
시간 120초: T6 = 43.0°C
시간 150초: T6 = 43.0°C (정상 상태 오차 0.0°C)

최종 결과:
✓ 상승 시간: 150초
✓ 오버슈트: 0.2°C
✓ 정상 상태 오차: 0.0°C
✓ 안정적인 제어
```

### 예시 2: 적응형 게인 (고부하 + 열대)

```python
# 조건
기본 게인: Kp=2.0, Ki=0.4, Kd=0.6
엔진 부하: 85% (고부하)
해수 온도: 32°C (열대)

# 스케일 계산
load_scale = 1.2 (고부하)
temp_correction = 1.2 (열대)
total_scale = 1.2 × 1.2 = 1.44

# 적응형 게인
actual_Kp = 2.0 × 1.44 = 2.88
actual_Ki = 0.4 × 1.44 = 0.58
actual_Kd = 0.6 × 1.44 = 0.86

# 효과
- 더 빠른 응답 (고부하 대응)
- 더 적극적인 냉각 (열대 환경)
```

---

## 🎯 게인 선택 가이드라인

### 시스템 특성별 권장 게인

| 시스템 특성 | Kp | Ki | Kd | 이유 |
|------------|----|----|----|----|
| 느린 응답 | 높음 | 중간 | 낮음 | 빠른 응답 필요 |
| 빠른 응답 | 중간 | 낮음 | 높음 | 안정성 우선 |
| 노이즈 많음 | 중간 | 낮음 | 낮음 | 노이즈 증폭 방지 |
| 정밀 제어 | 중간 | 높음 | 중간 | 정확도 우선 |

### 일반적인 게인 범위 (참고용)

**⚠️ 주의: 이것은 가능한 범위이지, 권장값이 아닙니다!**

```python
# 온도 제어 시스템에서 가능한 범위 (°C)
Kp: 1.0 ~ 5.0  # 대부분 1.5 ~ 2.5 사이에서 적절한 값 찾음
Ki: 0.1 ~ 1.0  # 대부분 0.3 ~ 0.5 사이에서 적절한 값 찾음
Kd: 0.5 ~ 2.0  # 대부분 0.5 ~ 0.8 사이에서 적절한 값 찾음

# 본 시스템의 실제 사용값 (검증된 값)
T5 제어: Kp=1.5, Ki=0.3, Kd=0.5
T6 제어: Kp=2.0, Ki=0.4, Kd=0.6
```

**권장 시작값:**
```python
# 처음 튜닝할 때는 작은 값부터 시작!
Kp = 1.0  # (Kp=5.0이 아님!)
Ki = 0.1
Kd = 0.0
```

---

## 🔍 문제 해결

### 문제 1: 진동 발생

**증상:**
```
온도가 목표값 주변에서 계속 진동
43°C → 44°C → 42°C → 44°C → ...
```

**원인:**
- Kp가 너무 큼
- Ki가 너무 큼

**해결:**
```python
# Kp 감소
Kp = Kp × 0.8

# 또는 Ki 감소
Ki = Ki × 0.5
```

### 문제 2: 느린 응답

**증상:**
```
목표 온도 도달까지 너무 오래 걸림
10분 이상 소요
```

**원인:**
- Kp가 너무 작음

**해결:**
```python
# Kp 증가
Kp = Kp × 1.5
```

### 문제 3: 정상 상태 오차

**증상:**
```
목표: 43°C
실제: 42.5°C (계속 유지)
```

**원인:**
- Ki가 너무 작거나 0

**해결:**
```python
# Ki 증가
Ki = Ki × 2.0

# 또는 Ki 추가
Ki = 0.2 (if Ki was 0)
```

### 문제 4: 큰 오버슈트

**증상:**
```
목표: 43°C
최대: 45°C (2°C 오버슈트)
```

**원인:**
- Kp가 너무 큼
- Kd가 너무 작음

**해결:**
```python
# Kp 감소
Kp = Kp × 0.8

# 또는 Kd 증가
Kd = Kd × 2.0
```

---

## 📚 참고 자료

### 튜닝 방법 비교

| 방법 | 장점 | 단점 | 적용 |
|------|------|------|------|
| Ziegler-Nichols | 빠름, 간단 | 오버슈트 큼 | 초기 설정 |
| Cohen-Coon | 정확함 | 모델 필요 | 정밀 제어 |
| 수동 튜닝 | 최적화 가능 | 시간 소요 | 최종 조정 |
| 적응형 | 다양한 조건 대응 | 복잡함 | 실제 운전 |

### 성능 지표

```python
# 좋은 PID 제어의 기준
상승 시간 (Rise Time): < 5분
오버슈트 (Overshoot): < 5%
정착 시간 (Settling Time): < 10분
정상 상태 오차 (SS Error): < 0.5°C
```

---

## 🎯 핵심 요약

### 1. 게인 결정 순서
```
1. Kp 조정 (빠른 응답)
2. Ki 조정 (오차 제거)
3. Kd 조정 (오버슈트 감소)
4. 반복 미세 조정
```

### 2. 적응형 게인
```
실제 게인 = 기본 게인 × 부하 스케일 × 온도 보정
```

### 3. 튜닝 원칙
```
- 보수적으로 시작
- 점진적으로 증가
- 안정성 우선
- 실제 조건에서 검증
```

---

생성일: 2025-10-15
버전: 1.0
작성자: AI Assistant

