# 🔮 온도 예측 알고리즘 상세 설명

## 개요
ESS AI 시스템이 T4, T5, T6 온도를 5/10/15분 후까지 예측하여 선제적으로 주파수를 제어하는 방법을 쉽게 설명합니다.

---

## 📚 1단계: 데이터 수집 (30분 이력)

시스템은 **20초마다** 센서 데이터를 수집합니다.

```
시간:  -30분  -25분  -20분  ...  -5분   -0분 (현재)
       ↓      ↓      ↓           ↓      ↓
T4:   44.8   44.9   45.0   ...  45.8   46.0°C  (상승 추세!)
T5:   34.8   34.9   35.0   ...  35.2   35.3°C
T6:   42.5   42.6   42.8   ...  43.5   43.8°C
엔진:  50%    52%    55%    ...  65%    70%    (부하 증가!)
```

**총 90개 데이터 포인트** (30분 ÷ 20초 = 90개)

### 버퍼 구조
```python
온도_시퀀스_버퍼 = {
    'timestamps': [시간1, 시간2, ..., 시간90],
    't4': [44.8, 44.9, ..., 46.0],  # T4 FW Inlet
    't5': [34.8, 34.9, ..., 35.3],  # T5 FW Outlet
    't6': [42.5, 42.6, ..., 43.8],  # T6 E/R Temp
    'engine_load': [50, 52, ..., 70]
}
```

---

## 🧮 2단계: 특징 추출 (Pattern 분석)

90개 데이터를 **19개 핵심 특징**으로 압축합니다.

### 예시: T4 온도 분석
```python
T4 데이터: [44.8, 44.9, 45.0, ..., 45.8, 46.0]

추출된 특징:
1. 현재값    = 46.0°C          (지금 온도)
2. 평균값    = 45.4°C          (30분 평균)
3. 표준편차  = 0.35°C          (변동폭)
4. 증가율    = +0.04°C/분      (추세: 상승 중!)
```

### 전체 19개 특징

| 그룹 | 특징 개수 | 내용 | 의미 |
|------|----------|------|------|
| **T4 특징** | 4개 | 현재, 평균, 표준편차, 증가율 | FW Inlet 패턴 |
| **T5 특징** | 4개 | 현재, 평균, 표준편차, 증가율 | FW Outlet 패턴 |
| **T6 특징** | 4개 | 현재, 평균, 표준편차, 증가율 | E/R 온도 패턴 |
| **엔진 부하** | 3개 | 현재, 평균, 증가율 | 부하 변화 추세 |
| **환경** | 2개 | T1 (해수), T7 (외기) | 외부 조건 |
| **시간** | 2개 | 시간대 (0-23), 계절 (0-3) | 운항 패턴 |
| **합계** | **19개** | - | - |

### 코드 예시
```python
def extract_features(sequence):
    features = []
    
    # T4 특징 (FW Inlet)
    t4_arr = array(sequence.t4)
    features.append(t4_arr[-1])           # 현재값
    features.append(mean(t4_arr))         # 평균
    features.append(std(t4_arr))          # 표준편차
    features.append((t4_arr[-1] - t4_arr[0]) / 90)  # 증가율
    
    # T5, T6, 엔진, 환경, 시간 동일하게...
    
    return features  # 총 19개
```

---

## 📈 3단계: Polynomial Regression (다항 회귀)

### 단순 예시로 이해하기

**만약 1개 특징만 있다면:**
```
x = T4 증가율

단순 직선:  y = a·x + b
          (증가율이 0.04면 항상 같은 비율로 상승)

다항식:     y = a·x² + b·x + c
          (증가율이 클수록 더 가속되어 상승!)
```

### 실제 예측 공식 (간단화)

```
T4_10분후 = a₁·(T4_현재) 
          + a₂·(T4_평균) 
          + a₃·(T4_표준편차)
          + a₄·(T4_증가율)
          + a₅·(엔진_부하)
          + a₆·(해수_온도)
          + a₇·(T4_현재)²              ← 제곱항 (비선형)
          + a₈·(T4 × 엔진부하)         ← 교차항 (상호작용)
          + ... (총 40개 계수)
```

### 왜 복잡한가?

1. **비선형 관계**
   ```
   엔진 부하 60% → 70%:   온도 +0.5°C
   엔진 부하 80% → 90%:   온도 +1.2°C  (가속!)
   ```

2. **상호작용 효과**
   ```
   T4 높음 + 엔진 부하 높음 = 더 빠른 상승!
   해수 온도 높음 + T5 높음 = Cooler 효율 저하!
   ```

3. **계절/시간 패턴**
   ```
   여름 (해수 28°C) vs 겨울 (해수 5°C)
   심야 (부하 낮음) vs 주간 (부하 높음)
   ```

---

## 🎓 4단계: 모델 학습 (과거 데이터로 배움)

### 학습 과정

```
[과거 데이터 50개 이상 필요]

학습 샘플 예시 1:
┌─────────────────────────────────────────────┐
│ 입력 (30분 전 패턴):                         │
│   T4 = 45.0°C, 증가율 = +0.03°C/분          │
│   엔진 = 60%, 해수 = 25°C                   │
├─────────────────────────────────────────────┤
│ 실제 결과 (10분 후):                         │
│   T4 = 45.3°C                               │
└─────────────────────────────────────────────┘

학습 샘플 예시 2:
┌─────────────────────────────────────────────┐
│ 입력 (30분 전 패턴):                         │
│   T4 = 46.0°C, 증가율 = +0.05°C/분          │
│   엔진 = 75%, 해수 = 27°C                   │
├─────────────────────────────────────────────┤
│ 실제 결과 (10분 후):                         │
│   T4 = 46.5°C                               │
└─────────────────────────────────────────────┘

... 50개 이상 학습 ...

→ 최적 계수 (a₁, a₂, ... a₄₀) 찾기!
  (Least Squares 방법 사용)
```

### 학습 결과

```python
모델 정보:
  - 학습 샘플: 50개 이상
  - 정확도: ±2-3°C
  - 추론 시간: <10ms
  - 모델 크기: ~0.7MB
  - 신뢰도: 학습 정확도 기반 계산
```

### 학습 알고리즘 (간단 설명)

```
1. 50개 샘플의 오차 계산
   오차 = |예측값 - 실제값|

2. 오차 합계를 최소화하는 계수 찾기
   최소화 대상: Σ(예측 - 실제)²

3. Least Squares (최소자승법) 사용
   → 수학적으로 최적 해를 한 번에 계산!
```

---

## 🔮 5단계: 실시간 예측

### 예시 시나리오

**현재 시간: 17:30**

#### 수집된 30분 데이터:
```
시간    T4     T5     T6    엔진부하
────────────────────────────────────
17:00  44.8   35.0   42.5    50%
17:05  45.0   35.0   42.8    52%
17:10  45.2   35.1   43.0    55%
17:15  45.5   35.1   43.2    60%
17:20  45.7   35.2   43.5    65%
17:25  45.9   35.2   43.7    68%
17:30  46.0   35.3   43.8    70%  ← 현재
```

#### 특징 추출 결과:
```python
T4_현재     = 46.0°C
T4_평균     = 45.4°C
T4_표준편차 = 0.35°C
T4_증가율   = +0.04°C/분  ← 주목! 계속 상승 중

T5_현재     = 35.3°C
T5_증가율   = +0.01°C/분

T6_현재     = 43.8°C
T6_증가율   = +0.04°C/분

엔진_부하   = 70%
엔진_증가율 = +0.67%/분  ← 부하도 증가 중!

해수_온도   = 26.0°C (T1)
시간대      = 17 (오후 5시)
계절        = 2 (여름)
```

#### 모델 예측 계산:
```python
# 학습된 계수로 계산 (간단화한 예시)
T4_5분후  = 46.0 + (0.04 × 5)  + 보정항 = 46.3°C
T4_10분후 = 46.0 + (0.04 × 10) + 보정항 = 46.7°C
T4_15분후 = 46.0 + (0.04 × 15) + 보정항 = 47.2°C

T5_10분후 = 35.3 + (0.01 × 10) + 보정항 = 35.8°C
T6_10분후 = 43.8 + (0.04 × 10) + 보정항 = 44.5°C

신뢰도 = 0.85 (85%)
추론 시간 = 8.3ms
```

#### 제어 결정:
```
예측 결과:
  T4: +0.7°C 상승 예상 (46.0 → 46.7°C)
  T5: +0.5°C 상승 예상 (35.3 → 35.8°C)
  T6: +0.7°C 상승 예상 (43.8 → 44.5°C)

선제적 제어:
  ✓ T4 +0.7°C → FW 펌프 +2Hz
  ✓ T5 +0.5°C → SW 펌프 +3Hz
  ✓ T6 +0.7°C → E/R 팬 +2Hz

최종 명령:
  SW 펌프: 48Hz → 51Hz (+3Hz)
  FW 펌프: 48Hz → 50Hz (+2Hz)
  E/R 팬:  48Hz → 50Hz (+2Hz)
```

---

## 📊 시각적 이해

### 그래프로 보는 예측

```
온도
°C
47 ┤                                ?  ← 예측 (15분 후)
   │                            ?
46 ┤                        ●/      ← 현재 (46.0°C)
   │                     ●/
45 ┤                  ●/
   │               ●/
44 ┤            ●/
   │         ●/
   │      ●/
   └─────────────────────────────────── 시간
   -30분  -20분  -10분  현재  +10분 +15분

● = 실제 측정값 (과거 30분)
/ = 추세선 (모델이 학습한 패턴)
? = 예측값 (미래)
```

### 모델이 하는 일:

1. **● 점들의 패턴 분석**
   - 직선? 곡선? 가속? 감속?
   - 변동폭은? 규칙적? 불규칙?

2. **추세선 연장**
   - 단순 직선 아님!
   - 비선형 곡선 고려
   - 다른 변수들 영향 반영

3. **미래 위치 예측**
   - 5분 후: ?
   - 10분 후: ?
   - 15분 후: ?

---

## 🧠 왜 정확한가?

### 1. 다양한 정보 활용

**단순 예측 (직선 연장만):**
```python
T4_10분후 = T4_현재 + (증가율 × 10)
         = 46.0 + (0.04 × 10) 
         = 46.4°C
```

**고급 예측 (모든 정보 활용):**
```python
T4_10분후 = f(T4, T5, T6, 엔진, 해수, 시간, 
              T4², T5², T6², 엔진²,
              T4×엔진, T5×엔진, T6×엔진, ...)
         = 46.7°C  ← 더 정확!
```

### 2. 비선형 관계 포착

```
선형 (직선):
  엔진 부하 60% → 70%: 온도 +0.5°C
  엔진 부하 70% → 80%: 온도 +0.5°C
  엔진 부하 80% → 90%: 온도 +0.5°C
  (항상 같은 비율)

비선형 (곡선):
  엔진 부하 60% → 70%: 온도 +0.5°C
  엔진 부하 70% → 80%: 온도 +0.8°C
  엔진 부하 80% → 90%: 온도 +1.2°C ← 가속!
  (제곱항으로 포착)
```

### 3. 상호작용 고려

**교차항의 힘:**
```
상황 A: T4=45°C, 엔진=60%  → 10분 후 +0.5°C
상황 B: T4=46°C, 엔진=60%  → 10분 후 +0.6°C
상황 C: T4=45°C, 엔진=80%  → 10분 후 +0.8°C
상황 D: T4=46°C, 엔진=80%  → 10분 후 +1.3°C ← 폭발적!

→ (T4 × 엔진) 교차항이 이를 포착!
```

### 4. 시간/계절 패턴

```
여름 (해수 28°C):
  같은 엔진 부하에도 온도 상승 빠름
  
겨울 (해수 5°C):
  Cooler 효율 좋음, 온도 안정적

→ 시간/계절 특징이 이를 반영!
```

---

## 🔄 실제 동작 흐름

```
┌─────────────────────────────────────────┐
│         [20초마다 반복]                  │
└─────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────┐
│ 1. 센서 데이터 수집                      │
│    T1, T2, T3, T4, T5, T6, T7, 엔진     │
└─────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────┐
│ 2. 30분 버퍼에 저장                      │
│    최신 90개 데이터 포인트 유지           │
└─────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────┐
│ 3. 19개 특징 추출 (<1ms)                 │
│    현재, 평균, 표준편차, 증가율, ...      │
└─────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────┐
│ 4. 정규화 (Normalization)                │
│    특징값들을 동일한 스케일로 변환         │
└─────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────┐
│ 5. 다항식 특징 생성                       │
│    제곱항, 교차항 추가 (19개 → 40개)      │
└─────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────┐
│ 6. Polynomial Regression 예측 (<10ms)    │
│    T4/T5/T6의 5/10/15분 후 예측          │
└─────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────┐
│ 7. 온도 변화 계산                         │
│    delta = 예측값 - 현재값               │
└─────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────┐
│ 8. 제어 결정 (증속/감속)                  │
│    SW 펌프, FW 펌프, E/R 팬 독립 제어     │
└─────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────┐
│ 9. VFD 명령 전송                          │
│    Modbus TCP로 주파수 변경 명령          │
└─────────────────────────────────────────┘
          ↓
     [20초 대기]
          ↓
    (처음부터 반복)
```

---

## 💡 쉬운 비유

### 날씨 예보와 비교

| 항목 | 기상청 날씨 예보 | ESS 온도 예측 |
|------|----------------|--------------|
| **과거 데이터** | 지난 30일 기상 데이터 | 지난 30분 온도 데이터 |
| **현재 상황** | 오늘 기온 상승 중 | T5 상승 추세 감지 |
| **예측 방법** | 수치 모델 (비선형) | Polynomial Regression |
| **예측 결과** | 내일 비 올 확률 70% | 10분 후 T5 +0.5°C |
| **대응** | 우산 준비! | SW 펌프 미리 증속! |

### 주식 예측과 비교

**주식 예측 (어려움):**
```
과거: 지난 30일 주가
현재: 상승 추세
예측: 내일 주가?
문제: 너무 많은 외부 변수 (뉴스, 정책, 심리, ...)
```

**온도 예측 (쉬움):**
```
과거: 지난 30분 온도
현재: 상승 추세
예측: 10분 후 온도?
장점: 물리 법칙 지배, 외부 변수 적음, 관성 큼
```

---

## 📝 핵심 요약

### 5단계 프로세스

| 단계 | 작업 | 입력 | 출력 | 시간 |
|------|------|------|------|------|
| **1** | 데이터 수집 | 센서 | 90개 포인트 | 30분 |
| **2** | 특징 추출 | 90개 → | 19개 특징 | <1ms |
| **3** | 모델 계산 | 19개 → | 9개 예측 | <10ms |
| **4** | 변화 분석 | 예측 - 현재 | 온도 변화 | <1ms |
| **5** | 제어 결정 | 온도 변화 | 주파수 조정 | <1ms |

### 수학적 표현 (간단화)

```
예측 = 선형항 + 비선형항 + 교차항

선형항    = a₁·T4 + a₂·T5 + a₃·엔진 + ...
비선형항  = b₁·T4² + b₂·T5² + b₃·엔진² + ...
교차항    = c₁·(T4×엔진) + c₂·(T5×해수) + ...

최종 예측 = 선형항 + 비선형항 + 교차항
```

### 성능 지표

```
✓ 정확도:    ±2-3°C
✓ 추론 시간: <10ms (목표 달성)
✓ 모델 크기: ~0.7MB (Xavier NX 메모리의 0.01%)
✓ 예측 범위: 5/10/15분 후
✓ 신뢰도:    학습 정확도 기반 (0-1)
```

---

## 🎯 결론

### 한 문장 요약:
**"지난 30분 동안 온도가 어떻게 변했는지 보고, 엔진 부하와 환경도 고려해서, 10분 후 온도를 다항식 수학 공식으로 예측하는 것!"**

### 핵심 개념:

1. **패턴 인식** 📊
   - 과거 30분 데이터에서 추세 파악
   - 단순 직선이 아닌 곡선 패턴

2. **다변수 고려** 🔢
   - T4, T5, T6, 엔진, 해수, 시간 등 19개 변수
   - 상호작용 효과까지 반영

3. **비선형 모델링** 📈
   - 제곱항으로 가속/감속 포착
   - 교차항으로 상승 효과 반영

4. **선제적 대응** ⚡
   - 10분 전 미리 증속
   - 긴급 60Hz 동작 방지

### 실무적 가치:

```
기존 (반응적):  온도 상승 → 60Hz 긴급 대응
예측 (선제적):  온도 상승 예측 → 55Hz 미리 증속

결과: 에너지 절감 +2-5%p 추가!
```

---

## 📚 참고 자료

### 관련 문서:
- `PREDICTIVE_CONTROL_INTEGRATION.md` - 구현 상세
- `PREDICTIVE_CONTROL_LOGIC_EXPLAINED.md` - 제어 로직
- `INTEGRATION_COMPLETE_SUMMARY.md` - 완료 보고서

### 코드 위치:
- `src/ml/temperature_predictor.py` - 예측 모델
- `src/control/integrated_controller.py` - 통합 제어
- `src/hmi/dashboard.py` - HMI 표시

---

**작성일**: 2025-10-14  
**버전**: 1.0  
**작성자**: ESS AI 시스템 개발팀

