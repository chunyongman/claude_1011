# 🔧 E/R 팬 주파수 고정 문제 수정

## 📋 문제 상황

E/R 환기 불량 시나리오에서:
- ❌ **E/R 팬 주파수가 40Hz로 고정**됨
- ❌ **대수만 2대 ↔ 3대로 변경**됨
- ❌ T6 온도가 45°C로 상승해도 주파수가 증가하지 않음

```
현재 화면:
T6: 45.0°C (+2.0°C)
E/R 팬 목표: 40.0 Hz (3대) ← 40Hz 고정!
대수 제어: [DEBUG] 40Hz 유지중 (T6=45.0°C), Timer=4s/10s (감소대기)
```

---

## 🔍 근본 원인

### 1️⃣ 대수 제어 조건 문제

```python
# 기존 코드 (문제)
elif decision.er_fan_freq <= 40.0:
    # 40Hz 이하면 대수 감소 대기
    # → 40Hz일 때 계속 타이머만 증가하고 주파수 변경 없음!
```

**문제점:**
- T6가 45°C로 상승해도 `decision.er_fan_freq`가 40Hz로 설정됨
- 대수 제어 로직에서 `<= 40.0` 조건에 걸림
- 타이머만 증가하고 주파수는 그대로

### 2️⃣ T6 온도 제어 범위 문제

```python
# 기존 코드 (문제)
if t6_temp > 45.0:
    decision.er_fan_freq = 60.0
elif t6_temp > 44.0:
    decision.er_fan_freq = max(decision.er_fan_freq, 55.0)
elif t6_temp < 42.0:  # ← 42-45°C 구간 제어 없음!
    decision.er_fan_freq = min(decision.er_fan_freq, current_er_freq - 2.0)
```

**문제점:**
- 42-45°C 구간에 대한 명확한 제어 로직이 없음
- T6=45°C일 때 60Hz가 아닌 55Hz만 적용
- PID 출력이 40Hz를 반환하면 그대로 유지

---

## ✅ 해결 방법

### 1️⃣ 대수 제어 조건 완화

```python
# 수정 후
# 대수 감소 조건: 주파수 ≤ 42Hz & 10초 대기 (42Hz 이하로 낮춤)
elif decision.er_fan_freq <= 42.0:  # 40Hz → 42Hz로 변경
    if time_at_min >= 10 and current_count > 2:
        decision.er_fan_count = current_count - 1
        # 대수 감소 후 주파수 약간 증가 (전체 풍량 유지)
        decision.er_fan_freq = min(50.0, decision.er_fan_freq + 5.0)
    else:
        decision.er_fan_count = current_count
        # 타이머 증가 (주파수는 변경 안 함)
else:
    # 42Hz 초과 시: 정상 운전
    decision.er_fan_count = current_count
```

**개선점:**
- 40Hz → 42Hz로 조건 완화
- 42-58Hz 구간에서는 대수 제어 개입 없음
- 주파수가 자유롭게 변할 수 있음

### 2️⃣ T6 온도 제어 범위 세분화

```python
# 수정 후
# 현재 온도 기반 즉각 대응 (PID + 예측 보완)
if t6_temp > 46.0:
    # 46°C 초과: 60Hz 긴급
    decision.er_fan_freq = 60.0
    decision.control_mode = "emergency_t6"
elif t6_temp > 45.0:
    # 45-46°C: 최소 58Hz
    decision.er_fan_freq = max(decision.er_fan_freq, 58.0)
    decision.control_mode = "high_t6"
elif t6_temp > 44.0:
    # 44-45°C: 최소 52Hz  ← 새로 추가!
    decision.er_fan_freq = max(decision.er_fan_freq, 52.0)
    decision.control_mode = "elevated_t6"
elif t6_temp < 41.0 and not use_predictive:
    # 41°C 미만: 감속
    decision.er_fan_freq = min(decision.er_fan_freq, current_er_freq - 2.0)
    decision.er_fan_freq = max(40.0, decision.er_fan_freq)
```

**개선점:**
- 44-45°C 구간 추가 → 최소 52Hz 보장
- 45-46°C 구간 → 58Hz 보장
- T6 온도에 따른 단계적 증속

### 3️⃣ 대수 증가/감소 시 주파수 보정

```python
# 대수 증가 시
if time_at_max >= 10 and current_count < 4:
    decision.er_fan_count = current_count + 1
    # 대수 증가 후 주파수 약간 감소 (전체 풍량 유지)
    decision.er_fan_freq = max(50.0, decision.er_fan_freq - 5.0)

# 대수 감소 시
if time_at_min >= 10 and current_count > 2:
    decision.er_fan_count = current_count - 1
    # 대수 감소 후 주파수 약간 증가 (전체 풍량 유지)
    decision.er_fan_freq = min(50.0, decision.er_fan_freq + 5.0)
```

**개선점:**
- 대수 변경 시 전체 풍량을 유지하도록 주파수 보정
- 3대 60Hz → 4대 55Hz (동일 풍량)
- 3대 40Hz → 2대 45Hz (동일 풍량)

---

## 🎬 수정 후 예상 동작

### E/R 환기 불량 시나리오

#### **Phase 1 (T6: 42→44°C)**
```
T6: 42.5°C → 정상 범위
E/R 팬: 48Hz (3대)
제어: PID + 에너지 절감
```

#### **Phase 2 (T6: 44→45°C)**
```
T6: 44.5°C → 44°C 초과!
E/R 팬: 52Hz (3대) ← 최소 52Hz 적용
제어: elevated_t6
이유: "T6=44.5°C > 44°C → 최소 52Hz"
```

#### **Phase 3 (T6: 45→46°C)**
```
T6: 45.3°C → 45°C 초과!
E/R 팬: 58Hz (3대) ← 최소 58Hz 적용
제어: high_t6
이유: "T6=45.3°C > 45°C → 최소 58Hz"
```

#### **Phase 4 (T6: 46°C 초과)**
```
T6: 46.2°C → 46°C 초과! 긴급!
E/R 팬: 60Hz (3대) ← 60Hz 강제
제어: emergency_t6
이유: "T6=46.2°C > 46°C → 60Hz 긴급 증속"
```

#### **Phase 5 (60Hz 지속 10초)**
```
T6: 47.0°C → 60Hz 유지
E/R 팬: 60Hz (3대)
대수 제어: Timer=10s/10s 완료
→ 대수 증가!
E/R 팬: 55Hz (4대) ← 4대로 증가, 주파수 보정
```

#### **Phase 6 (T6 하강: 45→44°C)**
```
T6: 44.5°C → 온도 하강
E/R 팬: 52Hz (4대) ← 주파수 감소
제어: elevated_t6
```

#### **Phase 7 (T6 하강: 44→42°C)**
```
T6: 42.5°C → 정상 범위
E/R 팬: 48Hz (4대)
제어: integrated_pid_energy
```

#### **Phase 8 (T6 하강: 42→40°C)**
```
T6: 40.5°C → 41°C 미만
E/R 팬: 42Hz (4대) ← 주파수 감소 (≤ 42Hz)
대수 제어: Timer=10s/10s 완료
→ 대수 감소!
E/R 팬: 47Hz (3대) ← 3대로 감소, 주파수 보정
```

---

## 📊 핵심 변경 사항 요약

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| **대수 감소 조건** | ≤ 40Hz | ≤ 42Hz |
| **T6 44-45°C** | 제어 없음 (PID 의존) | 최소 52Hz 강제 |
| **T6 45-46°C** | 최소 55Hz | 최소 58Hz |
| **T6 46°C 초과** | 60Hz | 60Hz (긴급 모드) |
| **대수 증가 후** | 60Hz 유지 | 55Hz로 보정 |
| **대수 감소 후** | 40Hz 유지 | 45Hz로 보정 |
| **주파수 변경 범위** | 40Hz 고정 경향 | 40-60Hz 자유 변경 |

---

## 🎯 테스트 체크리스트

- [ ] E/R 환기 불량 시나리오 시작
- [ ] T6: 42→44°C → 팬 주파수 48→52Hz 확인
- [ ] T6: 44→45°C → 팬 주파수 52→58Hz 확인
- [ ] T6: 45→46°C → 팬 주파수 58→60Hz 확인
- [ ] T6: 46→48°C → 팬 대수 3→4대 증가 확인
- [ ] 대수 증가 후 주파수 60→55Hz 보정 확인
- [ ] T6: 48→42°C → 팬 주파수 55→48Hz 감소 확인
- [ ] T6: 42→40°C → 팬 대수 4→3대 감소 확인
- [ ] 대수 감소 후 주파수 42→47Hz 보정 확인
- [ ] 전체 사이클 동안 주파수가 동적으로 변화하는지 확인

---

## 📁 수정된 파일

### `src/control/integrated_controller.py`

```python
# 주요 변경 라인:
- 라인 488-521: T6 온도 범위 제어 세분화
- 라인 546-586: 대수 제어 조건 및 주파수 보정 로직
```

---

## 🚀 적용 방법

```bash
# 변경사항 확인
git diff src/control/integrated_controller.py

# 대시보드 재시작
streamlit run src/hmi/dashboard.py --server.port 8501

# 브라우저에서 테스트
1. 시나리오 테스트 탭
2. "E/R 환기 불량" 선택
3. E/R 팬 주파수 변화 관찰
```

---

## 💡 결론

이제 **E/R 팬 주파수가 T6 온도에 따라 동적으로 변화**합니다!

```
T6 온도:  42°C → 44°C → 45°C → 46°C → 48°C → 42°C → 40°C
          ↓      ↓      ↓      ↓      ↓      ↓      ↓
팬 주파수: 48Hz → 52Hz → 58Hz → 60Hz → 55Hz → 48Hz → 47Hz
팬 대수:   3대    3대    3대    3대    4대    4대    3대
```

🎉 **주파수 고정 문제 해결 완료!**

