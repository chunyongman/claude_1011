# T6(E/R 온도) 제어 로직 수정 완료

## 📋 수정 개요

사용자 요구사항에 맞춰 **T6(E/R 온도) 제어 로직**을 올바르게 수정했습니다.

---

## ✅ 수정된 내용

### 1️⃣ 긴급 온도 임계값 변경

**변경 전:**
- T6 ≥ 50°C → 긴급 (Safety Layer S3)

**변경 후:**
- T6 > 45°C → 긴급 60Hz 강제 (Rule R3에 통합)
- Safety Layer S3는 압력 제약으로 변경

### 2️⃣ 정상 범위 제어 로직 수정

**변경 전 (잘못된 로직):**
```python
if t6_temp > 44.0:  # 44°C 초과
    er_freq = max(52.0, er_freq)  # 강제 52Hz
```
- 문제: 정상 범위(42~44°C)에서도 강제로 주파수 조정

**변경 후 (올바른 로직):**
```python
if 42.0 <= t6_temp <= 44.0:  # 정상 범위
    NORMAL_TARGET_FREQ = 48.0  # 목표 주파수
    
    if er_freq > NORMAL_TARGET_FREQ + 0.5:
        # 목표보다 높으면 단계적 감소
        er_freq = max(NORMAL_TARGET_FREQ, er_freq - 2.0)
    
    elif er_freq < NORMAL_TARGET_FREQ - 0.5:
        # 목표보다 낮으면 단계적 증가
        er_freq = min(NORMAL_TARGET_FREQ, er_freq + 2.0)
    
    else:
        # 목표 도달 → 현재 값 유지 (ML 예측만 적용)
        pass
```

---

## 🎯 새로운 T6 제어 로직

### **온도 구간별 제어**

```
┌─────────────────────────────────────────────┐
│  T6 > 45°C (긴급)                            │
│  Rule: S3_ER_HIGH_TEMP                       │
│  동작: 강제 60Hz                             │
│       → 30초 지속 시 대수 +1                 │
└─────────────────────────────────────────────┘
              ↓ 온도 하강
┌─────────────────────────────────────────────┐
│  44°C < T6 ≤ 45°C (과도 구간)                │
│  Rule: (긴급 해제, 정상 범위 진입 대기)      │
│  동작: 이전 주파수 유지                      │
└─────────────────────────────────────────────┘
              ↓ 온도 하강
┌─────────────────────────────────────────────┐
│  42°C ≤ T6 ≤ 44°C (정상 범위)                │
│  목표: 48Hz                                   │
│                                              │
│  현재 > 48Hz? → R3_T6_NORMAL_DECREASING     │
│    - 2Hz씩 단계적 감소 (48Hz까지)           │
│                                              │
│  현재 < 48Hz? → R3_T6_NORMAL_INCREASING     │
│    - 2Hz씩 단계적 증가 (48Hz까지)           │
│                                              │
│  현재 = 48Hz? → R3_T6_NORMAL_HOLD           │
│    - 현재 값 유지                            │
│    - ML 예측만 적용 (+2~4Hz 또는 -2~4Hz)   │
└─────────────────────────────────────────────┘
              ↓ 온도 하강
┌─────────────────────────────────────────────┐
│  40°C ≤ T6 < 42°C (저온)                     │
│  Rule: R3_T6_LOW                             │
│  동작: -2Hz씩 감속 (최소 40Hz)               │
└─────────────────────────────────────────────┘
              ↓ 온도 하강
┌─────────────────────────────────────────────┐
│  T6 < 40°C (매우 낮음)                       │
│  Rule: R3_T6_VERY_LOW                        │
│  동작: -4Hz씩 감속                           │
│       → 40Hz 30초 지속 시 대수 -1           │
└─────────────────────────────────────────────┘
```

---

## 📈 실제 동작 예시

### E/R 환기 불량 시나리오

```
시간    T6      현재주파수   판단                      동작
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
0분    43°C    48Hz        정상 범위 유지            48Hz 유지
                           [R3_T6_NORMAL_HOLD]

1분    44°C    48Hz        정상 범위 경계            48Hz 유지
                           [R3_T6_NORMAL_HOLD]
                           ML 예측: 10분 후 46°C
                           → 선제 증속 +3Hz (51Hz)

2분    45°C    51Hz        과도 구간                 51Hz 유지

2.5분  46°C    51Hz        긴급!                     강제 60Hz!
                           [S3_ER_HIGH_TEMP]

3분    48°C    60Hz        긴급 지속                 60Hz 유지
                           30초 지속 → 대수 증가
                           (3대 → 4대, 주파수 조정 60→52Hz)

4분    46°C    52Hz        긴급 지속                 52Hz 유지

5분    45°C    52Hz        과도 구간                 52Hz 유지

6분    44°C    52Hz        정상 범위 진입!           52→50Hz
                           [R3_T6_NORMAL_DECREASING]
                           현재(52) > 목표(48)

6.5분  43.5°C  50Hz        정상 범위                 50→48Hz
                           [R3_T6_NORMAL_DECREASING]

7분    43°C    48Hz        정상 범위 안정!           48Hz 유지
                           [R3_T6_NORMAL_HOLD]

8분    42°C    48Hz        정상 범위 경계            48Hz 유지
                           ML 예측: 10분 후 40°C
                           → 선제 감속 -2Hz (46Hz)

9분    41°C    46Hz        저온!                     46→44Hz
                           [R3_T6_LOW]

10분   40°C    44Hz        저온                      44→42Hz
                           [R3_T6_LOW]

10.5분 39°C    42Hz        저온                      42→40Hz
                           [R3_T6_LOW]

11분   38°C    40Hz        매우 낮음                 40Hz 유지
                           [R3_T6_VERY_LOW]
                           30초 지속 → 대수 감소
                           (4대 → 3대, 주파수 조정 40→48Hz)

12분   39°C    48Hz        매우 낮음                 48→44Hz
                           [R3_T6_VERY_LOW]
```

---

## 🔑 핵심 개념

### 1. **정상 범위(42~44°C)의 "유지"**

**의미:**
- 목표 주파수 = 48Hz
- 현재 주파수가 목표와 다르면 → 단계적 수렴
- 목표 도달 후 → 진정한 유지 (ML 예측만 적용)

**히스테리시스:**
- ±0.5Hz 이내는 목표 도달로 간주
- 떨림 방지

### 2. **긴급 온도 45°C**

**45°C 선택 이유:**
- 목표 온도: 43°C
- 안전 마진: +2°C
- 정상 범위 상한: 44°C
- 긴급 발동: 44°C + 1°C = 45°C

### 3. **목표 주파수로 수렴**

**왜 필요한가:**
- 60Hz에서 급격히 44°C 진입 시
- 60Hz 그대로 유지? → 에너지 낭비
- 48Hz로 단계적 감소 → 효율적 운영

---

## 📝 수정된 파일

### `src/control/rule_based_controller.py`

**주요 변경:**
1. Line 63: `t6_emergency = 45.0` (45°C 긴급 온도)
2. Line 140-146: Safety Layer S3를 압력 제약으로 변경
3. Line 205-250: Rule R3 완전 재작성
   - 45°C 긴급 처리
   - 42~44°C 정상 범위 목표 주파수(48Hz) 수렴
   - <42°C 저온 단계적 감속
4. Line 390-406: `get_rule_info()` 업데이트
   - Safety rules: 4개 → 3개
   - R3 설명 업데이트

---

## ✅ 테스트 결과

```
============================================================
All tests passed!
============================================================

테스트 1: 정상 운전
  - R3_T6_NORMAL_HOLD 적용 ✅
  - 48Hz 유지 확인 ✅

테스트 2: Cooler 과열
  - S1_COOLER_PROTECTION 발동 ✅
  - 60Hz 강제 확인 ✅

테스트 3: ML 예측 통합
  - ML_PREDICTION + R3_T6_NORMAL_HOLD ✅
  - 예측 기반 조정 확인 ✅

Rule Info:
  - Safety rules: 3개 ✅
  - R3 설명: "45°C 긴급, 42~44°C 정상, <42°C 저온" ✅
```

---

## 🚀 확인 방법

### 1. 대시보드 접속
```
http://localhost:8501
```

### 2. 시나리오 테스트
1. "🎬 시나리오 테스트" 탭 클릭
2. "시나리오 모드 활성화" ✅
3. "E/R 환기 불량" 선택

### 3. 적용된 규칙 확인
- **"📋 적용된 규칙 보기"** 확장 메뉴
- 실시간으로 변경되는 규칙 확인:
  - `S3_ER_HIGH_TEMP` (45°C 초과)
  - `R3_T6_NORMAL_DECREASING` (정상 범위 복귀)
  - `R3_T6_NORMAL_HOLD` (목표 도달)
  - `R3_T6_LOW` (저온)

---

## 📊 변경 요약

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| **긴급 온도** | 50°C | **45°C** |
| **정상 범위** | 42~44°C (강제 48Hz) | **42~44°C (목표 48Hz 수렴)** |
| **44°C 초과** | 52Hz 강제 | **이전 주파수 유지** |
| **정상 범위 유지** | 불명확 | **목표 주파수로 수렴 후 유지** |
| **Safety Rules** | 4개 (S1~S4) | **3개 (S1~S3)** |
| **T6 긴급 처리** | Safety S3 | **Rule R3 통합** |

---

## 🎯 장점

### ✅ 논리적 일관성
- 정상 범위에서 "유지"의 의미가 명확
- 목표 주파수 수렴 → 진정한 유지

### ✅ 에너지 효율
- 불필요한 고주파수 운전 방지
- 단계적 감속으로 부드러운 전환

### ✅ 예측 제어 통합
- 정상 범위에서 ML 예측 적극 활용
- 선제적 대응으로 온도 안정화

### ✅ 투명성
- 각 온도 구간별 명확한 규칙
- 대시보드에서 실시간 추적 가능

---

**수정 완료일**: 2025-10-16  
**상태**: ✅ 테스트 완료, 대시보드 재시작 완료  
**다음 단계**: 대시보드에서 E/R 환기 불량 시나리오 실행하여 확인

